<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Degguiden" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Degguiden – Pizzeria v2.3.17-brand</title>
<style>
  :root{
    /* Brand vars (will be overridden by palette extractor) */
    --brand:#e4572e;        /* primary accent from logo */
    --brand-600:#c14422;    /* darken */
    --brand-300:#f29a7f;    /* lighten */
    --brand-100:#fde7df;    /* very light */

    --bg:#f8fafc; --panel:#ffffff; --panel-2:#f1f5f9; --border:#e2e8f0; --muted:#475569;
    --accent: var(--brand);
    --warn:#b45309; --danger:#ef4444; --radius:16px;
    --b1a:var(--brand-100); --b1b:#fff; --b1border:var(--brand-300);
    --b2a:#f5e8ff; --b2b:#fbf7ff; --b2border:#d8b4fe;
  }
  *{box-sizing:border-box}
  html,body{height:100%; overflow-x:hidden;}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:#0f172a;line-height:1.45}
  header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.75);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding:10px 16px;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  header h1{margin:0;font-size:18px;font-weight:800}
  .logo{height:28px;width:28px;border-radius:6px;object-fit:cover;margin-right:8px}
  .belowOptions{margin-top:12px}
  .stackedCards{max-width:680px;margin:0 auto;display:grid;gap:10px}
  .stackedCards .card{width:100%}
  header .ver{padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:var(--panel-2);font-weight:700}

  main{max-width:1200px;margin:16px auto 120px;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 24px rgba(15,23,42,.06)}
  .stack{display:grid;gap:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted)}
  .btn{border:1px solid #cbd5e1;background:#fff;color:#0f172a;padding:14px 18px;border-radius:12px;cursor:pointer;font-weight:700;font-size:16px;min-height:44px;display:inline-block;text-decoration:none}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.secondary{background:#0f172a;color:#fff;border-color:#0f172a}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
  .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .btn.ghost{background:transparent;border-color:#cbd5e1}
  .btn.outline{background:transparent;border-color:var(--accent);color:var(--accent)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}

  .narrow{max-width:840px;margin:0 auto}

  /* Onboarding */
  #viewOnboard{text-align:center}
  .onboard-actions{max-width:520px;margin:0 auto}
  .onboard-steps{list-style:decimal-leading-zero;padding-left:1.5rem;text-align:left;margin:6px auto 10px;max-width:520px;color:#334155}
  .onboard-steps li{margin:2px 0}
  .onboard-actions .row{justify-content:center;gap:12px;margin:6px 0}
  .onboard-actions .btn{min-width:220px}
  @media (max-width:560px){.onboard-actions .btn{width:100%}}

  /* HERO */
  .hero{border-radius:24px;padding:20px;text-align:center;box-shadow:0 16px 40px rgba(15,23,42,.08);border:1px solid;position:relative;overflow:hidden;max-width:840px;margin:0 auto;background:var(--panel)}
  .hero.batch1{background:linear-gradient(180deg,var(--b1a),var(--b1b));border-color:var(--b1border)}
  .hero.batch2{background:linear-gradient(180deg,#f1f0ff,#ffffff);border-color:#d9d6ff}
  .hero .batchTag{font-weight:900;letter-spacing:.08em;color:#0f172a;text-transform:uppercase}
  .hero .stepNum{font-size:13px;color:#1d4ed8;letter-spacing:.08em;text-transform:uppercase}
  .hero .stepName{font-weight:800;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.1;font-size:28px}
  .hero .hint{margin-top:8px;color:#0f172a;font-weight:800;font-size:18px}
  .hero .timerWrap{display:grid;place-items:center;gap:8px;margin-top:12px}
  .hero .time{font-variant-numeric:tabular-nums;font-size:56px;font-weight:900}
  .hero .controls{display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
  .hero .ackWrap{margin-top:12px}
  .hero .ackBtn{display:none;padding:16px 20px}
  @keyframes alarmFlash{0%,100%{box-shadow:0 16px 40px rgba(15,23,42,.08);}50%{box-shadow:0 0 0 6px rgba(239,68,68,.45),0 16px 40px rgba(15,23,42,.14);}}
  .hero.alarming{animation:alarmFlash .9s ease-in-out infinite}

  /* Progress */
  .progWrap{text-align:left;margin-top:12px}
  .track{position:relative;height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar.overall{position:absolute;inset:0;width:0%;background:var(--brand-300)}
  .bar.time{position:absolute;inset:0;width:0%;background:var(--accent);mix-blend-mode:multiply}
  .progText{display:flex;justify-content:space-between;margin-top:6px;font-size:12px;color:var(--muted)}

  /* Steglista */
  .stepsTopBar{display:flex;justify-content:space-between;align-items:center;gap:8px;margin:8px 0}
  .steps{display:grid;gap:10px}
  .step{display:grid;gap:6px;padding:12px;border:1px dashed #cbd5e1;border-radius:12px;background:var(--panel-2);opacity:.35;max-width:840px;margin:0 auto}
  .step.active{opacity:1;border:1px solid var(--brand-300);background:var(--panel);box-shadow:0 8px 24px rgba(15,23,42,.08)}

  .field{display:grid;gap:6px}
  .field input{background:#fff;border:1px solid #cbd5e1;color:#0f172a;border-radius:10px;padding:12px;font-size:16px}
  .field input.error{border-color:#ef4444;background:#fff5f5}
  .kpi{font-weight:900;font-size:26px}

  .view{display:none}
  .view.show{display:block}

  /* Tillsätt-block */
  .addBlock{margin-top:10px;padding:12px;border:1px solid #cbd5e1;border-radius:12px;background:var(--panel)}
  .addBlock .title{font-weight:800;margin-bottom:6px}
  .addList{list-style:none;padding:0;margin:0;display:grid;gap:10px;justify-content:center}
  .addItem{text-align:center}
  .addItem .lab{display:block;font-weight:900;font-size:22px;line-height:1.06;margin:0}
  .addItem .amt{display:block;font-weight:700;font-size:16px;line-height:1.08;margin:0;color:#0f172a}

  /* Inaktiv batch bar */
  #inactiveBar{display:none;max-width:840px;margin:10px auto 0}
  #inactiveBar .inner{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--panel-2)}
  #inactiveBar.batch1 .inner{background:linear-gradient(180deg,var(--b1a),var(--b1b));border-color:var(--b1border)}
  #inactiveBar.batch2 .inner{background:linear-gradient(180deg,#f1f0ff,#ffffff);border-color:#d9d6ff}
  #inactiveBar .tag{font-weight:900;letter-spacing:.08em;text-transform:uppercase}
  #inactiveBar .time{font-variant-numeric:tabular-nums;font-weight:900}

  /* Batch options stacked */
  .optionsStack{max-width:680px;margin:0 auto;display:grid;gap:10px}
  .optCard{display:flex;gap:12px;align-items:center;border:1px solid #cbd5e1;border-radius:12px;padding:12px;background:#fff;cursor:pointer}
  .optCard:has(input:checked){border-color:var(--accent);box-shadow:0 0 0 2px var(--brand-100)}
  .optCard input{transform:scale(1.3)}

  /* Modal */
  .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:100}
  .modal{background:var(--panel);border:1px solid var(--border);border-radius:18px;width:min(94vw,560px);padding:18px}
</style>
</head>
<body>
<header>
  <div class="row"><img src="https://joakimlagerqvist821-source.github.io/800graderdeg/85D4DC81-9284-43F7-BB63-A98750228389.jpeg" alt="800 Grader" class="logo" /></div>
  <div class="ver">v2.3.17-brand</div>
</header>

<main>
  <!-- ONBOARDING -->
  <section id="viewOnboard" class="view show card stack">
    <h2>Steg 1: Helskärm & alarm</h2>
    <ol class="onboard-steps">
      <li>Starta helskärm (valfritt)</li>
      <li>Aktivera ljud (krävs för alarm på iPhone)</li>
      <li>Testa alarm</li>
      <li>Nästa: fortsätt till batch-val</li>
    </ol>
    <div class="onboard-actions">
      <div class="row">
        <button class="btn outline" id="enterFs" type="button">⤢ Starta helskärm</button>
      </div>
      <p id="fsHint" class="muted"></p>
      <div class="row">
        <button class="btn secondary" id="unlockAudioBtn" type="button">🔔 Aktivera ljud</button>
        <button class="btn warn" id="testAlarmBtn" type="button">🔊 Testa alarm</button>
      </div>
      <div class="row"><button class="btn primary" id="toBatch" type="button">Nästa ▶</button></div>
    </div>
  </section>

  <!-- BATCH VAL -->
  <section id="viewBatch" class="view card stack">
    <h2>Steg 2: Välj antal batch</h2>
    <div class="optionsStack">
      <label class="optCard"><input type="radio" name="batch" value="1"><div><strong>1×</strong><div class="muted">122 bollar</div></div></label>
      <label class="optCard"><input type="radio" name="batch" value="1.5"><div><strong>1.5×</strong><div class="muted">183 bollar</div></div></label>
      <label class="optCard"><input type="radio" name="batch" value="2"><div><strong>2×</strong><div class="muted">244 bollar</div></div></label>
    </div>
    <div class="row belowOptions" style="justify-content:space-between"><button class="btn" id="backToOnboard" type="button">◀ Tillbaka</button><button class="btn primary" id="toTemps" type="button">Nästa ▶</button></div>
  </section>

  <!-- TEMPERATURER -->
  <section id="viewTemps" class="view card stack">
    <h2>Steg 3: Temperaturer & friktion</h2>
    <div class="row" style="justify-content:center;gap:12px;flex-wrap:wrap">
      <div class="field" style="min-width:240px"><label>Mjöltemp (°C)</label><input type="number" id="flourTemp" step="0.1" inputmode="decimal" placeholder="t.ex. 20"></div>
      <div class="field" style="min-width:240px"><label>Rumstemp (°C)</label><input type="number" id="roomTemp" step="0.1" inputmode="decimal" placeholder="t.ex. 22"></div>
      <div class="field" style="min-width:240px"><label>Önskad degtemp (°C)</label><input type="number" id="targetTemp" step="0.1" inputmode="decimal" value="22"><div class="muted">Standard: 22 °C</div></div>
      <div class="field" style="min-width:240px"><label>Friktionstal (°C)</label><input type="number" id="friction" step="0.1" inputmode="decimal" placeholder="t.ex. 8"></div>
      <div class="field" style="min-width:240px"><label>Beräknad vattentemp (°C)</label><div class="kpi" id="waterCalc">—</div></div>
    </div>
    <div class="row" style="justify-content:space-between">
      <button class="btn" id="backToBatch" type="button">◀ Tillbaka</button>
      <div class="row">
        <button class="btn" id="saveTemps" type="button" disabled>Spara</button>
        <button class="btn primary" id="toPreWeigh" type="button" disabled>Spara & fortsätt ▶</button>
      </div>
    </div>
  </section>

  <!-- FÖRVÄGNING -->
  <section id="viewPre" class="view card stack">
    <h2>Steg 4: Väg upp enligt batch</h2>
    <div class="stackedCards">
      <div class="card"><div class="preLabel">Vatten</div><div class="bigBreak" id="preWaterBig">—</div></div>
      <div class="card"><div class="preLabel">Salt</div><div class="bigBreak" id="preSaltBig">—</div></div>
      <div class="card"><div class="preLabel">Olivolja</div><div class="bigBreak" id="preOilBig">—</div></div>
    </div>
    <div class="row" style="justify-content:space-between"><button class="btn" id="backToTemps" type="button">◀ Tillbaka</button><button class="btn primary" id="toMixing" type="button">Börja degblandning ▶</button></div>
  </section>

  <!-- MIXFLÖDE -->
  <section id="viewMix" class="view stack">
    <div class="hero batch1" id="hero">
      <div class="batchTag" id="heroBatchLabel">Batch 1</div>
      <div class="stepNum" id="heroStepNum">Steg —</div>
      <div class="stepName" id="heroStepName">—</div>
      <div class="hint" id="heroHint"></div>
      <div class="progWrap"><div class="track"><div class="bar overall" id="heroProgOverall"></div><div class="bar time" id="heroProgTime"></div></div><div class="progText"><span id="heroProgLabel">Steg — av 7</span><span id="heroProgPct">0%</span></div></div>
      <div class="timerWrap" id="heroTimerWrap" style="display:none"><div class="time" id="timerDisplay">00:00</div><div class="controls"><button class="btn" id="timerPause" type="button">Pausa</button><button class="btn" id="timerReset" type="button">Nollställ</button></div><div class="ackWrap"><button class="btn danger ackBtn" id="ackBtn" type="button">⏰ Stoppa alarm och nästa steg</button></div></div>
      <div class="row" style="justify-content:center;gap:8px;margin-top:10px"><button class="btn" id="prevStep" type="button">◀ Föregående</button><button class="btn primary" id="nextStep" type="button">Nästa ▶</button></div>
    </div>
    <div id="inactiveBar"><div class="inner"><span class="tag" id="inactiveLbl">Batch 2</span><span class="info" id="inactiveStep">—</span><span class="time" id="inactiveTimer">—</span><button class="btn ghost" id="inactiveJump" type="button">Gå till denna batch</button></div></div>
    <div class="card narrow" style="margin-top:12px"><div class="stepsTopBar"><div><strong id="stepBadge">1 / 7</strong></div></div><div class="steps" id="stepsContainer"></div></div>
  </section>
</main>

<!-- MODAL för temp -->
<div class="modalBack" id="tempModalBack"><div class="modal"><h3 id="tempModalTitle">Ange degtemperatur</h3><div class="field"><label>Temperatur (°C)</label><input type="number" id="tempInput" step="0.1" placeholder="t.ex. 22.0" inputmode="decimal"></div><div class="row" style="margin-top:12px"><button class="btn" id="tempCancel" type="button">Avbryt</button><button class="btn primary" id="tempSave" type="button">Spara & fortsätt ▶</button></div></div></div>

<audio id="beepFallback" preload="auto" playsinline>
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAZGF0YQAAAAAAAAD///8AAAAAAP///wAAAP///wAAAP///wAAAP///wAAAP///wAAAP///wAAAP///wAAAP///w==" type="audio/wav">
</audio>

<script>
(function(){
  // ===== Helpers (ES5) =====
  function $(sel){ return document.querySelector(sel); }
  function byId(id){ return document.getElementById(id); }
  function on(id,ev,fn){ var el=byId(id); if(el){ el.addEventListener(ev,fn,false); } }
  function pad2(n){ return (n<10?'0':'')+n; }
  function fmt(s){ s=Math.max(0,Math.floor(s)); var m=Math.floor(s/60), r=s%60; return pad2(m)+':'+pad2(r); }
  function fsSupported(){ return !!(document.documentElement.requestFullscreen || document.documentElement.webkitRequestFullscreen); }
  if (!Element.prototype.closest) { Element.prototype.closest = function(s){ var el=this; if(!document.documentElement.contains(el)) return null; do { if (el.matches && el.matches(s)) return el; el=el.parentElement||el.parentNode; } while(el&&el.nodeType===1); return null; }; }

  // ===== State =====
  var state = {
    batchMult:+(localStorage.getItem('deg_batch')||1),
    base:{ water:1250, salt:450, oil:450 },
    B1:{ id:1, idx:0, deadline:0, running:false },
    B2:{ id:2, idx:0, deadline:0, running:false },
    active:1, dualMode:false, b2Started:false,
    tickHandle:null,
    audioCtx:null, gain:null, alarmTimer:null, alarmOn:false, volume:+(localStorage.getItem('deg_alarm_vol')||0.85),
    flour:null, room:null, target:22, friction:null, waterCalc:null,
    pendingTemp:null
  };

  var steps = [
    {id:1, duration:0},
    {id:2, duration:6*60},
    {id:3, duration:30*60},
    {id:4, duration:6*60},
    {id:5, duration:7*60},
    {id:6, duration:30*60},
    {id:7, duration:0}
  ];

  // ===== View switching =====
  function show(id){
    var ids=['viewOnboard','viewBatch','viewTemps','viewPre','viewMix'];
    for(var i=0;i<ids.length;i++){ var el=byId(ids[i]); if(el){ el.classList.remove('show'); } }
    var tgt=byId(id); if(tgt){ tgt.classList.add('show'); }
    if(id!=='viewMix' && state.tickHandle){ cancelAnimationFrame(state.tickHandle); state.tickHandle=null; }
    if(id==='viewMix' && !state.tickHandle){ state.tickHandle=requestAnimationFrame(tick); }
  }

  // ===== Audio / Alarm (robust unlock) =====
  function ensureAudio(){ if(state.audioCtx) return; var Ctx=window.AudioContext||window.webkitAudioContext; if(!Ctx) return; state.audioCtx=new Ctx(); state.gain=state.audioCtx.createGain(); state.gain.gain.value=state.volume; state.gain.connect(state.audioCtx.destination); }
  function unlockAudioOnce(){ ensureAudio(); try{ if(state.audioCtx && state.audioCtx.state==='suspended' && state.audioCtx.resume){ state.audioCtx.resume(); } }catch(e){}
    var el=byId('beepFallback'); if(el){ try{ el.muted=false; el.currentTime=0; el.play(); }catch(e){} }
  }
  function playBeep(freq, dur){ if(freq==null) freq=1000; if(dur==null) dur=0.25; try{ if(!state.audioCtx) return; var osc=state.audioCtx.createOscillator(); var g=state.audioCtx.createGain(); osc.type='square'; osc.frequency.value=freq; g.gain.setValueAtTime(0,state.audioCtx.currentTime); g.gain.linearRampToValueAtTime(state.volume,state.audioCtx.currentTime+0.02); g.gain.linearRampToValueAtTime(0.0001,state.audioCtx.currentTime+dur); osc.connect(g).connect(state.gain); osc.start(); osc.stop(state.audioCtx.currentTime+dur+0.05); }catch(e){} }
  function startAlarm(){ unlockAudioOnce(); ensureAudio(); try{ if(state.audioCtx && state.audioCtx.state==='suspended' && state.audioCtx.resume){ state.audioCtx.resume(); } }catch(e){}
    if(state.alarmOn) return; state.alarmOn=true; byId('hero').classList.add('alarming'); var flip=false;
    state.alarmTimer=setInterval(function(){ if(state.audioCtx) playBeep(flip?1000:1500,0.28); else { var el=byId('beepFallback'); if(el){ try{ el.currentTime=0; el.play(); }catch(e){} } }
      if(navigator.vibrate){ try{ navigator.vibrate(120); }catch(e){} } flip=!flip; }, 700);
  }
  function stopAlarm(){ state.alarmOn=false; if(state.alarmTimer){ clearInterval(state.alarmTimer); state.alarmTimer=null; } byId('hero').classList.remove('alarming'); }

  document.addEventListener('visibilitychange', function(){ if(!document.hidden){ try{ unlockAudioOnce(); }catch(e){} } }, false);
  ;['pointerdown','touchstart','touchend','click'].forEach(function(evt){ document.addEventListener(evt, function once(){ try{ unlockAudioOnce(); }catch(e){} document.removeEventListener(evt, once, {capture:false}); }, {passive:true}); });

  // ===== Text (original live) =====
  function perBatch(){ return { water:state.base.water, salt:state.base.salt, oil:state.base.oil }; }
  function waterLabel(){ return (typeof state.waterCalc==='number') ? (' (vattentemp: '+(Math.round(state.waterCalc*10)/10)+' °C)') : ''; }
  function stepTitle(id){
    switch(id){
      case 1: return 'Häll i vatten i degblandaren.';
      case 2: return 'Starta degblandaren och kör på hastighet 1 i 6 minuter.';
      case 3: return 'Autolys – vila 30 minuter.';
      case 4: return 'Starta degblandaren och kör på hastighet 1 i 6 minuter.';
      case 5: return 'Starta degblandaren och kör på hastighet 2 i 7 minuter.';
      case 6: return 'Vik degen – vila 30 minuter.';
      case 7: return 'Vik igen, plasta & lock – in i kyl.';
    }
    return '';
  }
  function stepHint(id){
    var a = perBatch();
    switch(id){
      case 1: return 'Använd beräknad vattentemperatur' + waterLabel() + '.';
      case 2: return 'Tillsätt mjöl.';
      case 3: return 'Låt degen vila i 30 minuter (autolys).';
      case 4: return 'Tillsätt jäst under körning.';
      case 5: return 'Tillsätt i denna ordning:<br>'+
                   '1) Extra vatten' + waterLabel() + ' – <strong>' + a.water + ' g (per batch)</strong><br>'+
                   '2) Salt – <strong>' + a.salt + ' g (per batch)</strong><br>'+
                   '3) Olivolja – <strong>' + a.oil + ' g (per batch)</strong>';
      case 6: return 'Vik degen en gång och låt vila.';
      case 7: return 'Vik igen, plasta & lock och kyl.';
    }
    return '';
  }

  // ===== Batches =====
  function batchObj(n){ return n===1?state.B1:state.B2; }
  function currentBatch(){ return batchObj(state.active); }
  function otherBatch(){ return batchObj(state.active===1?2:1); }
  function setIdx(b, idx){ b.idx=Math.max(0,Math.min(idx,steps.length-1)); var st=steps[b.idx]; if(st.duration>0){ b.deadline=Date.now()+st.duration*1000; b.running=false; } else { b.deadline=0; b.running=false; } }
  function remaining(b){ if(!b.deadline) return 0; return Math.max(0, Math.ceil((b.deadline-Date.now())/1000)); }

  // ===== Render =====
  function renderSteps(){ var b=currentBatch(); var c=byId('stepsContainer'); c.innerHTML='';
    for(var idx=b.idx; idx<steps.length; idx++){
      var stepId=idx+1; var div=document.createElement('div'); div.className='step'+(idx===b.idx?' active':'');
      var dur=steps[idx].duration?('⏱ '+fmt(steps[idx].duration)) : '';
      div.innerHTML='<div style="opacity:.8;font-weight:800;">'+stepId+'. '+stepTitle(stepId)+'</div>'+
                    '<div class="muted">'+stepHint(stepId)+'</div>'+(dur?'<div class="muted">'+dur+'</div>':'');
      c.appendChild(div);
    }
  }
  function updateInactiveBar(){ var bar=byId('inactiveBar'); if(!state.dualMode){ bar.style.display='none'; return; }
    var ob=otherBatch(); var started = (ob.idx>0) || (ob.deadline>0) || ob.running || (state.active===2);
    if(state.active===1 && ob.id===2 && !started){ bar.style.display='none'; return; }
    bar.style.display='block'; bar.classList.toggle('batch1', ob.id===1); bar.classList.toggle('batch2', ob.id===2);
    byId('inactiveLbl').textContent='Batch '+ob.id;
    byId('inactiveStep').textContent='Steg '+(ob.idx+1)+': '+stepTitle(ob.idx+1);
    byId('inactiveTimer').textContent= steps[ob.idx].duration>0 ? fmt(remaining(ob)) : '—';
    on('inactiveJump','click', function(){ state.active=ob.id; refreshHero(); });
  }
  function refreshHero(){ var b=currentBatch(); var stepId=b.idx+1; var hero=byId('hero');
    if(state.active===1){ hero.classList.add('batch1'); hero.classList.remove('batch2'); } else { hero.classList.add('batch2'); hero.classList.remove('batch1'); }
    byId('heroBatchLabel').textContent='Batch '+state.active;
    byId('stepBadge').textContent=(b.idx+1)+' / '+steps.length;
    byId('heroStepNum').textContent='Steg '+stepId;
    byId('heroStepName').textContent=stepTitle(stepId);
    byId('heroHint').innerHTML=stepHint(stepId);
    var overall=Math.min(100,Math.max(0,(b.idx)/(steps.length-1)*100));
    byId('heroProgOverall').style.width=overall+'%';
    byId('heroProgPct').textContent=Math.round(overall)+'%';
    byId('heroProgLabel').textContent='Steg '+stepId+' av '+steps.length;
    var showTimer=steps[b.idx].duration>0; byId('heroTimerWrap').style.display=showTimer?'grid':'none';
    byId('timerDisplay').textContent=fmt(remaining(b));
    renderSteps(); updateInactiveBar();
  }

  // ===== Timer =====
  function tick(){ var b=currentBatch(); var st=steps[b.idx];
    if(st.duration>0 && b.running && remaining(b)<=0){ b.running=false; if((b.idx+1)===5){ stopAlarm(); openTempModal(5,state.active); }
      else { byId('ackBtn').style.display='inline-block'; startAlarm(); } }
    byId('timerDisplay').textContent=fmt(remaining(b));
    if(st.duration>0 && b.deadline){ var rem=remaining(b); var elapsed=Math.max(0,st.duration-rem); var frac=Math.min(1,elapsed/st.duration); byId('heroProgTime').style.width=(frac*100)+'%'; } else { byId('heroProgTime').style.width='0%'; }
    updateInactiveBar();
    state.tickHandle=requestAnimationFrame(tick);
  }
  function startTimer(){ var b=currentBatch(); var st=steps[b.idx]; if(st.duration<=0) return; if(!b.deadline){ b.deadline=Date.now()+st.duration*1000; } b.running=true; byId('timerPause').textContent='Pausa'; }
  function stopTimer(){ var b=currentBatch(); b.running=false; byId('timerPause').textContent='Fortsätt'; }
  function resetTimer(){ var b=currentBatch(); var st=steps[b.idx]; b.deadline=st.duration>0?(Date.now()+st.duration*1000):0; b.running=false; byId('timerPause').textContent='Fortsätt'; }

  // ===== Temp modal (efter steg 5) =====
  function openTempModal(stepId,batch){ state.pendingTemp={stepId:stepId,batch:batch}; byId('tempModalTitle').textContent='Ange degtemperatur – Batch '+batch+' efter steg '+stepId; byId('tempInput').value=''; byId('tempModalBack').style.display='flex'; byId('tempInput').focus(); }
  function closeTempModal(){ byId('tempModalBack').style.display='none'; }
  function saveTemp(){ var v=parseFloat((byId('tempInput').value||'').replace(',','.')); if(isNaN(v)){ alert('Fyll i en giltig temperatur.'); return; }
    var was=state.pendingTemp?{stepId:state.pendingTemp.stepId,batch:state.pendingTemp.batch}:null; closeTempModal(); state.pendingTemp=null;
    if(was && was.stepId===5){ var b=currentBatch(); if(b.idx<steps.length-1){ setIdx(b,b.idx+1); refreshHero(); } }
  }

  // ===== Water calc + validation =====
  function num(id){ var raw=(byId(id).value||'').replace(',','.'); var v=parseFloat(raw); return isFinite(v)?v:NaN; }
  function isTempsValid(){ var f=num('flourTemp'), r=num('roomTemp'), fr=num('friction'); return isFinite(f)&&isFinite(r)&&isFinite(fr); }
  function updateWaterCalc(){
    var t=num('targetTemp'); var f=num('flourTemp'), r=num('roomTemp'), fr=num('friction');
    var target=isFinite(t)?t:22;
    var ok = isFinite(target)&&isFinite(f)&&isFinite(r)&&isFinite(fr);
    var w = ok ? ((target*3)-(f+r+fr)) : null;
    byId('waterCalc').textContent=(w==null?'—':(Math.round(w*10)/10)+' °C');
    state.waterCalc = w;
    // UI validation
    ['flourTemp','roomTemp','friction'].forEach(function(id){ var el=byId(id); if(!el) return; var v=num(id); el.classList.toggle('error', !isFinite(v)); });
    var enable = isTempsValid();
    byId('saveTemps').disabled = !enable;
    byId('toPreWeigh').disabled = !enable;
  }

  // ===== Pre-weigh parts =====
  function partsText(mult, base){ var half=Math.round(base/2); if(Math.abs(mult-2)<1e-3) return {big:'2 × '+base+' g', total:2*base}; if(Math.abs(mult-1.5)<1e-3) return {big:'1 × '+base+' g + 1 × '+half+' g', total:base+half}; return {big:'1 × '+base+' g', total:base}; }
  function refreshPreWeigh(){ var m=state.batchMult||1; var bw=partsText(m,state.base.water), bs=partsText(m,state.base.salt), bo=partsText(m,state.base.oil); byId('preWaterBig').textContent=bw.big; byId('preSaltBig').textContent=bs.big; byId('preOilBig').textContent=bo.big; }

  // ===== Navigation =====
  on('enterFs','click', function(){ if(fsSupported()){ try{ (document.documentElement.requestFullscreen||document.documentElement.webkitRequestFullscreen).call(document.documentElement); }catch(e){} } else { var h=byId('fsHint'); if(h){ h.textContent='Din webbläsare saknar helskärmsstöd.'; } } });
  on('unlockAudioBtn','click', function(){ unlockAudioOnce(); var el=byId('beepFallback'); if(el){ try{ el.currentTime=0; el.play(); }catch(e){} } });
  on('testAlarmBtn','click', function(){ unlockAudioOnce(); startAlarm(); setTimeout(stopAlarm,2000); });

  on('toBatch','click', function(){ show('viewBatch'); });
  on('backToOnboard','click', function(){ show('viewOnboard'); });

  on('toTemps','click', function(){
    var sel=document.querySelector('input[name="batch"]:checked');
    if(!sel){ alert('Välj antal batch först.'); return; }
    state.batchMult=parseFloat(sel.value); localStorage.setItem('deg_batch', state.batchMult);
    show('viewTemps'); updateWaterCalc();
  });
  on('backToBatch','click', function(){ show('viewBatch'); });

  on('saveTemps','click', function(){ if(!isTempsValid()){ alert('Fyll i Mjöltemp, Rumstemp och Friktionstal.'); return; } updateWaterCalc(); });
  on('toPreWeigh','click', function(){ if(!isTempsValid()){ alert('Fyll i Mjöltemp, Rumstemp och Friktionstal.'); return; } updateWaterCalc(); show('viewPre'); refreshPreWeigh(); });
  on('backToTemps','click', function(){ show('viewTemps'); });

  on('toMixing','click', function(){ state.dualMode = (state.batchMult>=2); state.b2Started=false; setIdx(state.B1,0); setIdx(state.B2,0); state.active=1; show('viewMix'); refreshHero(); });
  on('prevStep','click', function(){ var b=currentBatch(); if(b.idx>0){ setIdx(b,b.idx-1); refreshHero(); } });
  on('nextStep','click', function(){ var b=currentBatch(); if(b.idx<steps.length-1){ setIdx(b,b.idx+1); if(state.dualMode && state.active===1 && (b.idx+1)===3){ state.active=2; state.b2Started=true; setIdx(state.B2,0); refreshHero(); return; } refreshHero(); } });
  on('timerPause','click', function(){ var st=steps[currentBatch().idx]; if(st.duration>0){ currentBatch().running?stopTimer():startTimer(); } });
  on('timerReset','click', function(){ resetTimer(); });
  on('ackBtn','click', function(){ stopAlarm(); byId('ackBtn').style.display='none'; var b=currentBatch(); if(b.idx<steps.length-1){ setIdx(b,b.idx+1); refreshHero(); } });

  on('inactiveJump','click', function(){ state.active = otherBatch().id; refreshHero(); });

  // Temp modal events
  on('tempSave','click', saveTemp);
  on('tempCancel','click', function(){ closeTempModal(); state.pendingTemp=null; });
  byId('tempModalBack').addEventListener('click', function(e){ if(e.target.id==='tempModalBack'){ closeTempModal(); state.pendingTemp=null; } }, false);

  // Inputs
  ['targetTemp','flourTemp','roomTemp','friction'].forEach(function(id){ var el=byId(id); if(el){ el.addEventListener('input', updateWaterCalc,false); el.addEventListener('change', updateWaterCalc,false);} });

  // ===== Brand palette extractor from logo =====
  (function extractBrand(){
    var URL_LOGO = 'https://joakimlagerqvist821-source.github.io/800graderdeg/85D4DC81-9284-43F7-BB63-A98750228389.jpeg';
    try{
      var img=new Image(); img.crossOrigin='anonymous';
      img.onload=function(){
        var w=32,h=32, cv=document.createElement('canvas'); cv.width=w; cv.height=h; var cx=cv.getContext('2d');
        cx.drawImage(img,0,0,w,h);
        var data=cx.getImageData(0,0,w,h).data; var hist={}, i, r,g,b, key;
        function sat(r,g,b){ var max=Math.max(r,g,b), min=Math.min(r,g,b); return max? (max-min)/max:0; }
        for(i=0;i<data.length;i+=4){ r=data[i]; g=data[i+1]; b=data[i+2]; if(data[i+3]<128) continue; // skip transparent
          // quantize to 16 levels per channel
          r=r>>4; g=g>>4; b=b>>4; key=r+','+g+','+b; hist[key]=(hist[key]||0)+1; }
        var top=Object.keys(hist).map(function(k){ var p=k.split(','); var rr=parseInt(p[0],10)<<4, gg=parseInt(p[1],10)<<4, bb=parseInt(p[2],10)<<4; return {k:k, n:hist[k], r:rr,g:gg,b:bb, s:sat(rr,gg,bb)}; })
          .sort(function(a,b){ return b.n-a.n; }).slice(0,24);
        // pick most saturated among top few to avoid beige/white
        top.sort(function(a,b){ return (b.s*1.2 + b.n/1000) - (a.s*1.2 + a.n/1000); });
        var pick=top[0]||{r:228,g:87,b:46};
        function clamp(x,a,b){ return Math.max(a,Math.min(b,x)); }
        function mix(c, t, f){ return Math.round(c + (t-c)*f); }
        var r0=pick.r,g0=pick.g,b0=pick.b;
        var rDark=clamp(Math.round(r0*0.75),0,255), gDark=clamp(Math.round(g0*0.75),0,255), bDark=clamp(Math.round(b0*0.75),0,255);
        var rLight=mix(r0,255,0.6), gLight=mix(g0,255,0.6), bLight=mix(b0,255,0.6);
        var rSoft=mix(r0,255,0.85), gSoft=mix(g0,255,0.85), bSoft=mix(b0,255,0.85);
        var root=document.documentElement.style;
        root.setProperty('--brand', 'rgb('+r0+','+g0+','+b0+')');
        root.setProperty('--brand-600', 'rgb('+rDark+','+gDark+','+bDark+')');
        root.setProperty('--brand-300', 'rgb('+rLight+','+gLight+','+bLight+')');
        root.setProperty('--brand-100', 'rgb('+rSoft+','+gSoft+','+bSoft+')');
      };
      img.onerror=function(){};
      img.src=URL_LOGO;
    }catch(e){}
  })();

  // Public API fallback for iOS
  window.DG = {
    toBatch: function(){ try{ show('viewBatch'); }catch(e){} },
    unlockAudio: function(){ try{ unlockAudioOnce(); var el=document.getElementById('beepFallback'); if(el){ el.currentTime=0; el.play(); } }catch(e){} },
    testAlarm: function(){ try{ unlockAudioOnce(); startAlarm(); setTimeout(stopAlarm,2000); }catch(e){} },
    enterFs: function(){ try{ var rfs=(document.documentElement.requestFullscreen||document.documentElement.webkitRequestFullscreen); if(rfs) rfs.call(document.documentElement); }catch(e){} }
  };

  // Safety delegate for critical buttons
  document.addEventListener('click', function(ev){
    var t = ev.target || ev.srcElement; var btn = t && (t.closest ? t.closest('button') : t);
    if(!btn || !btn.id) return;
    if(btn.id==='toBatch'){ ev.preventDefault(); DG.toBatch(); }
    else if(btn.id==='unlockAudioBtn'){ ev.preventDefault(); DG.unlockAudio(); }
    else if(btn.id==='testAlarmBtn'){ ev.preventDefault(); DG.testAlarm(); }
    else if(btn.id==='enterFs'){ ev.preventDefault(); DG.enterFs(); }
  }, false);

  // Start
  show('viewOnboard');
})();
</script>
</body>
</html>
