<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Degguiden" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Degguiden ‚Äì Pizzeria v2.3.8 SAFE</title>
<style>
  :root{
    --bg:#f8fafc; --panel:#ffffff; --panel-2:#f1f5f9; --border:#e2e8f0; --muted:#475569;
    --accent:#2563eb; --warn:#b45309; --danger:#ef4444; --radius:16px;
    --b1a:#e8f0ff; --b1b:#f5f9ff; --b1border:#93c5fd;
    --b2a:#f5e8ff; --b2b:#fbf7ff; --b2border:#d8b4fe;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:#0f172a;line-height:1.45}
  header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.75);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding:10px 16px;display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center}
  header h1{margin:0;font-size:18px;font-weight:800}
  header .meta{display:flex;gap:10px;align-items:center;font-size:12px;color:var(--muted)}
  header .ver{padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:var(--panel-2);font-weight:700}
  main{max-width:1200px;margin:16px auto 120px;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 24px rgba(15,23,42,.06)}
  .stack{display:grid;gap:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted)}
  .btn{border:1px solid #cbd5e1;background:#fff;color:#0f172a;padding:14px 18px;border-radius:12px;cursor:pointer;font-weight:700;font-size:16px;min-height:44px;display:inline-block;text-decoration:none}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
  .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .btn.ghost{background:transparent;border-color:#cbd5e1}

  .narrow{max-width:840px;margin:0 auto}

  /* Onboarding layout */
  #viewOnboard{text-align:center}
  .onboard-actions{max-width:480px;margin:0 auto}
  .onboard-actions .row{justify-content:center;gap:12px;margin:6px 0}
  .onboard-actions .btn{min-width:220px}
  @media (max-width:520px){.onboard-actions .btn{width:100%}}

  /* HERO */
  .hero{border-radius:24px;padding:20px;text-align:center;box-shadow:0 16px 40px rgba(15,23,42,.08);border:1px solid;position:relative;overflow:hidden;max-width:840px;margin:0 auto;background:var(--panel)}
  .hero.batch1{background:linear-gradient(180deg,var(--b1a),var(--b1b));border-color:var(--b1border)}
  .hero.batch2{background:linear-gradient(180deg,var(--b2a),var(--b2b));border-color:var(--b2border)}
  .hero .batchTag{font-weight:900;letter-spacing:.08em;color:#0f172a;text-transform:uppercase}
  .hero .stepNum{font-size:13px;color:#1d4ed8;letter-spacing:.08em;text-transform:uppercase}
  .hero .stepName{font-weight:800;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.1;font-size:28px}
  .hero .hint{margin-top:8px;color:#0f172a;font-weight:800;font-size:18px}
  .hero .timerWrap{display:grid;place-items:center;gap:8px;margin-top:12px}
  .hero .time{font-variant-numeric:tabular-nums;font-size:56px;font-weight:900}
  .hero .controls{display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
  .hero .ackWrap{margin-top:12px}
  .hero .ackBtn{display:none;padding:16px 20px}
  @keyframes alarmFlash{0%,100%{box-shadow:0 16px 40px rgba(15,23,42,.08);}50%{box-shadow:0 0 0 6px rgba(239,68,68,.45),0 16px 40px rgba(15,23,42,.14);}}
  .hero.alarming{animation:alarmFlash .9s ease-in-out infinite}

  /* Progress */
  .progWrap{text-align:left;margin-top:12px}
  .track{position:relative;height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar.overall{position:absolute;inset:0;width:0%;background:#c7d2fe}
  .bar.time{position:absolute;inset:0;width:0%;background:#2563eb;mix-blend-mode:multiply}
  .progText{display:flex;justify-content:space-between;margin-top:6px;font-size:12px;color:var(--muted)}

  /* Steglista */
  .stepsTopBar{display:flex;justify-content:space-between;align-items:center;gap:8px;margin:8px 0}
  .steps{display:grid;gap:10px}
  .step{display:grid;gap:6px;padding:12px;border:1px dashed #cbd5e1;border-radius:12px;background:var(--panel-2);opacity:.35;max-width:840px;margin:0 auto}
  .step.active{opacity:1;border:1px solid #93c5fd;background:var(--panel);box-shadow:0 8px 24px rgba(15,23,42,.08)}

  .field{display:grid;gap:6px}
  .field input{background:#fff;border:1px solid #cbd5e1;color:#0f172a;border-radius:10px;padding:12px;font-size:16px}
  .kpi{font-weight:900;font-size:26px}

  .view{display:none}
  .view.show{display:block}

  /* Tills√§tt-block */
  .addBlock{margin-top:10px;padding:12px;border:1px solid #cbd5e1;border-radius:12px;background:var(--panel)}
  .addBlock .title{font-weight:800;margin-bottom:6px}
  .addList{list-style:none;padding:0;margin:0;display:grid;gap:10px;justify-content:center}
  .addItem{text-align:center}
  .addItem .lab{display:block;font-weight:900;font-size:22px;line-height:1.06;margin:0}
  .addItem .amt{display:block;font-weight:700;font-size:16px;line-height:1.08;margin:0;color:#0f172a}

  /* Inaktiv batch bar */
  #inactiveBar{display:none;max-width:840px;margin:10px auto 0}
  #inactiveBar .inner{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--panel-2)}
  #inactiveBar.batch1 .inner{background:linear-gradient(180deg,var(--b1a),var(--b1b));border-color:var(--b1border)}
  #inactiveBar.batch2 .inner{background:linear-gradient(180deg,var(--b2a),var(--b2b));border-color:var(--b2border)}
  #inactiveBar .tag{font-weight:900;letter-spacing:.08em;text-transform:uppercase}
  #inactiveBar .time{font-variant-numeric:tabular-nums;font-weight:900}

  /* Modal */
  .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:100}
  .modal{background:var(--panel);border:1px solid var(--border);border-radius:18px;width:min(94vw,560px);padding:18px}
</style>
</head>
<body>
<header>
  <div class="row"><h1 id="title">üßë‚Äçüç≥ Degguiden</h1></div>
  
  <div class="meta ver">v2.3.8</div>
</header>

<main>
  <!-- ONBOARDING -->
  <section id="viewOnboard" class="view show card stack">
    <h2>Steg 1: Helsk√§rm & alarm</h2>
    <div class="onboard-actions">
      <div class="row"><button class="btn primary" id="enterFs">‚§¢ Starta helsk√§rm</button></div>
      <p id="fsHint" class="muted"></p>
      <div class="row"><button class="btn" id="unlockAudioBtn">üîî Aktivera ljud</button><button class="btn warn" id="testAlarmBtn">üîä Testa alarm</button></div>
      <div class="row"><button class="btn primary" id="toBatch">N√§sta ‚ñ∂</button></div>
    </div>
  </section>

  <!-- BATCH VAL -->
  <section id="viewBatch" class="view card stack">
    <h2>Steg 2: V√§lj antal batch</h2>
    <div class="row" style="justify-content:center;gap:12px">
      <label class="card row" style="gap:12px;align-items:center"><input type="radio" name="batch" value="1"><div><strong>1√ó</strong><div class="muted">122 bollar</div></div></label>
      <label class="card row" style="gap:12px;align-items:center"><input type="radio" name="batch" value="1.5"><div><strong>1.5√ó</strong><div class="muted">183 bollar</div></div></label>
      <label class="card row" style="gap:12px;align-items:center"><input type="radio" name="batch" value="2"><div><strong>2√ó</strong><div class="muted">244 bollar</div></div></label>
    </div>
    <div class="row" style="justify-content:space-between"><button class="btn" id="backToOnboard">‚óÄ Tillbaka</button><button class="btn primary" id="toTemps">N√§sta ‚ñ∂</button></div>
  </section>

  <!-- TEMPERATURER -->
  <section id="viewTemps" class="view card stack">
    <h2>Steg 3: Temperaturer & friktion</h2>
    <div class="row" style="justify-content:center;gap:12px;flex-wrap:wrap">
      <div class="field" style="min-width:240px"><label>Mj√∂ltemp (¬∞C)</label><input type="number" id="flourTemp" step="0.1" inputmode="decimal" placeholder="t.ex. 20"></div>
      <div class="field" style="min-width:240px"><label>Rumstemp (¬∞C)</label><input type="number" id="roomTemp" step="0.1" inputmode="decimal" placeholder="t.ex. 22"></div>
      <div class="field" style="min-width:240px"><label>√ñnskad degtemp (¬∞C)</label><input type="number" id="targetTemp" step="0.1" inputmode="decimal" value="22"><div class="muted">Standard: 22 ¬∞C</div></div>
      <div class="field" style="min-width:240px"><label>Friktionstal (¬∞C)</label><input type="number" id="friction" step="0.1" inputmode="decimal" placeholder="t.ex. 8"></div>
      <div class="field" style="min-width:240px"><label>Ber√§knad vattentemp (¬∞C)</label><div class="kpi" id="waterCalc">‚Äî</div><div class="muted">(√ñnskad √ó 3) ‚àí (Mj√∂l + Rum + Friktion)</div></div>
    </div>
    <div class="row" style="justify-content:space-between"><button class="btn" id="backToBatch">‚óÄ Tillbaka</button><div class="row"><button class="btn" id="saveTemps">Spara</button><button class="btn primary" id="toPreWeigh">Spara & forts√§tt ‚ñ∂</button></div></div>
  </section>

  <!-- F√ñRV√ÑGNING -->
  <section id="viewPre" class="view card stack">
    <h2>Steg 4: V√§g upp enligt batch</h2>
    <div class="row" style="justify-content:center;gap:12px;flex-wrap:wrap">
      <div class="card"><div class="preLabel">Vatten</div><div class="bigBreak" id="preWaterBig">‚Äî</div><div class="smallTotal" id="preWaterSmall">= ‚Äî g</div></div>
      <div class="card"><div class="preLabel">Salt</div><div class="bigBreak" id="preSaltBig">‚Äî</div><div class="smallTotal" id="preSaltSmall">= ‚Äî g</div></div>
      <div class="card"><div class="preLabel">Olivolja</div><div class="bigBreak" id="preOilBig">‚Äî</div><div class="smallTotal" id="preOilSmall">= ‚Äî g</div></div>
    </div>
    <div class="row" style="justify-content:space-between"><button class="btn" id="backToTemps">‚óÄ Tillbaka</button><button class="btn primary" id="toMixing">B√∂rja degblandning ‚ñ∂</button></div>
  </section>

  <!-- MIXFL√ñDE -->
  <section id="viewMix" class="view stack">
    <div class="hero batch1" id="hero">
      <div class="batchTag" id="heroBatchLabel">Batch 1</div>
      <div class="stepNum" id="heroStepNum">Steg ‚Äî</div>
      <div class="stepName" id="heroStepName">‚Äî</div>
      <div class="hint" id="heroHint"></div>
      <div class="progWrap"><div class="track"><div class="bar overall" id="heroProgOverall"></div><div class="bar time" id="heroProgTime"></div></div><div class="progText"><span id="heroProgLabel">Steg ‚Äî av 7</span><span id="heroProgPct">0%</span></div></div>
      <div class="timerWrap" id="heroTimerWrap" style="display:none"><div class="time" id="timerDisplay">00:00</div><div class="controls"><button class="btn" id="timerPause">Pausa</button><button class="btn" id="timerReset">Nollst√§ll</button></div><div class="ackWrap"><button class="btn danger ackBtn" id="ackBtn">‚è∞ Stoppa alarm och n√§sta steg</button></div></div>
      <div class="row" style="justify-content:center;gap:8px;margin-top:10px"><button class="btn" id="prevStep">‚óÄ F√∂reg√•ende</button><button class="btn primary" id="nextStep">N√§sta ‚ñ∂</button></div>
    </div>
    <div id="inactiveBar"><div class="inner"><span class="tag" id="inactiveLbl">Batch 2</span><span class="info" id="inactiveStep">‚Äî</span><span class="time" id="inactiveTimer">‚Äî</span><button class="btn ghost" id="inactiveJump">G√• till denna batch</button></div></div>
    <div class="card narrow" style="margin-top:12px"><div class="stepsTopBar"><div><strong id="stepBadge">1 / 7</strong></div></div><div class="steps" id="stepsContainer"></div></div>
  </section>
</main>

<!-- MODAL f√∂r temp -->
<div class="modalBack" id="tempModalBack"><div class="modal"><h3 id="tempModalTitle">Ange degtemperatur</h3><div class="field"><label>Temperatur (¬∞C)</label><input type="number" id="tempInput" step="0.1" placeholder="t.ex. 22.0" inputmode="decimal"></div><div class="row" style="margin-top:12px"><button class="btn" id="tempCancel">Avbryt</button><button class="btn primary" id="tempSave">Spara & forts√§tt ‚ñ∂</button></div></div></div>

<audio id="beepFallback" preload="auto" playsinline>
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAZGF0YQAAAAAAAAD///8AAAAAAP///wAAAP///wAAAP///wAAAP///wAAAP///wAAAP///wAAAP///wAAAP///w==" type="audio/wav">
</audio>

<script>
window.addEventListener('DOMContentLoaded', function(){
  // ==== Helpers ====
  const $ = (sel)=>document.querySelector(sel);
  const byId = (id)=>document.getElementById(id);
  const on = (id,ev,fn)=>{ const el=byId(id); if(el) el.addEventListener(ev,fn); };
  const pad2 = (n)=> (n<10?'0':'')+n;
  const fmt = (s)=>{ s=Math.max(0,Math.floor(s)); const m=Math.floor(s/60), r=s%60; return pad2(m)+':'+pad2(r); };
  const fsSupported = ()=> !!document.documentElement.requestFullscreen;

  // ==== State ====
  const state = {
    batchMult:+(localStorage.getItem('deg_batch')||1),
    base:{ water:1250, salt:450, oil:450 },
    B1:{ id:1, idx:0, deadline:0, running:false },
    B2:{ id:2, idx:0, deadline:0, running:false },
    active:1, dualMode:false, b2Started:false,
    tickHandle:null,
    audioCtx:null, gain:null, alarmTimer:null, alarmOn:false, volume:+(localStorage.getItem('deg_alarm_vol')||0.85),
    flour:null, room:null, target:22, friction:null, waterCalc:null,
    handoffVisible:false, pendingTemp:null
  };

  const steps = [
    {id:1, duration:0},
    {id:2, duration:6*60},
    {id:3, duration:30*60},
    {id:4, duration:6*60},
    {id:5, duration:7*60},
    {id:6, duration:30*60},
    {id:7, duration:0}
  ];

  // ==== View switching ====
  function show(id){
    ['viewOnboard','viewBatch','viewTemps','viewPre','viewMix'].forEach(v=>{ const el=byId(v); if(el) el.classList.remove('show'); });
    const tgt=byId(id); if(tgt) tgt.classList.add('show');
    if(id!=='viewMix' && state.tickHandle){ cancelAnimationFrame(state.tickHandle); state.tickHandle=null; }
    if(id==='viewMix' && !state.tickHandle){ state.tickHandle=requestAnimationFrame(tick); }
  }

  // ==== Audio / Alarm (robust unlock) ====
  function ensureAudio(){ if(state.audioCtx) return; const Ctx=window.AudioContext||window.webkitAudioContext; if(!Ctx) return; state.audioCtx=new Ctx(); state.gain=state.audioCtx.createGain(); state.gain.gain.value=state.volume; state.gain.connect(state.audioCtx.destination); }
  function unlockAudioOnce(){ ensureAudio(); try{ if(state.audioCtx && state.audioCtx.state==='suspended'){ state.audioCtx.resume(); } }catch(e){}
    const el=byId('beepFallback'); if(el){ try{ el.muted=false; el.currentTime=0; el.play(); }catch(e){} }
  }
  function playBeep(freq=1000, dur=0.25){ try{ if(!state.audioCtx) return; const osc=state.audioCtx.createOscillator(); const g=state.audioCtx.createGain(); osc.type='square'; osc.frequency.value=freq; g.gain.setValueAtTime(0,state.audioCtx.currentTime); g.gain.linearRampToValueAtTime(state.volume,state.audioCtx.currentTime+0.02); g.gain.linearRampToValueAtTime(0.0001,state.audioCtx.currentTime+dur); osc.connect(g).connect(state.gain); osc.start(); osc.stop(state.audioCtx.currentTime+dur+0.05); }catch(e){} }
  function startAlarm(){ unlockAudioOnce(); ensureAudio(); try{ if(state.audioCtx && state.audioCtx.state==='suspended'){ state.audioCtx.resume(); } }catch(e){}
    if(state.alarmOn) return; state.alarmOn=true; $('#hero').classList.add('alarming'); let flip=false; state.alarmTimer=setInterval(()=>{ if(state.audioCtx) playBeep(flip?1000:1500,0.28); else { const el=byId('beepFallback'); if(el){ try{ el.currentTime=0; el.play(); }catch(e){} } } if(navigator.vibrate){ try{ navigator.vibrate(120); }catch(e){} } flip=!flip; }, 700); }
  function stopAlarm(){ state.alarmOn=false; if(state.alarmTimer){ clearInterval(state.alarmTimer); state.alarmTimer=null; } $('#hero').classList.remove('alarming'); }

  // ==== Steps text ====
  function waterLabel(){ return (typeof state.waterCalc==='number')?(' (vattentemp: '+(Math.round(state.waterCalc*10)/10)+' ¬∞C)'):''; }
  function perBatch(){ return { water:state.base.water, salt:state.base.salt, oil:state.base.oil }; }
  function addBlock(items,title){ let html='<div class="addBlock"><div class="title">'+(title||'Tills√§tt:')+'</div><ul class="addList">'; items.forEach(it=>{ html+='<li class="addItem"><span class="lab">'+it.label+'</span>'+(it.amt?'<span class="amt">'+it.amt+'</span>':'')+'</li>'; }); html+='</ul></div>'; return html; }
  function stepTitle(id){
  switch(id){
    case 1: return 'H√§ll i vatten i degblandaren';
    case 2: return 'K√∂r degblandaren Hastighet 1';
    case 3: return 'Autolys';
    case 4: return 'K√∂r degblandaren p√• Hastighet 2';
    case 5: return 'K√∂r degblandaren p√• Hastighet 2';
    case 6: return 'Vik 1 - Vila';
    case 7: return 'Vik 2';
  }
  return '';
}
function stepHint(id){
  const a = perBatch();
  switch(id){
    case 1: return 'Vattentemp: ' + (typeof state.waterCalc==='number' ? (Math.round(state.waterCalc*10)/10 + ' ¬∞C') : '‚Äî');
    case 2: return 'Tills√§tt mj√∂l';
    case 3: return '';
    case 4: return 'Tills√§tt j√§st';
    case 5: return addBlock([
      {label:'Vatten', amt: a.water + ' g / batch'},
      {label:'Salt',  amt: a.salt  + ' g / batch'},
      {label:'Olja',  amt: a.oil   + ' g / batch'}
    ], 'Tills√§tt');
    case 6: return '';
    case 7: return '';
  }
  return '';
}
],'Tills√§tt:');
    case 3: return 'L√•t degen vila i 30 minuter (autolys).';
    case 4: return addBlock([{label:'J√§st'}],'Tills√§tt under k√∂rning:');
    case 5: return addBlock([{label:'Vatten',amt:a.water+' g / batch'},{label:'Salt',amt:a.salt+' g / batch'},{label:'Olivolja',amt:a.oil+' g / batch'}],'I f√∂ljande ordning, tills√§tt:');
    case 6: return 'Vik 1 - Vila 30 minuter';
    case 7: return 'Vik 2 - Plasta och st√§ll i kylsk√•p.';
  } return ''; }

  // ==== Batches ====
  const batchObj = (n)=> n===1?state.B1:state.B2;
  const currentBatch = ()=> batchObj(state.active);
  const otherBatch = ()=> batchObj(state.active===1?2:1);
  function setIdx(b, idx){ b.idx=Math.max(0,Math.min(idx,steps.length-1)); const st=steps[b.idx]; if(st.duration>0){ b.deadline=Date.now()+st.duration*1000; b.running=false; } else { b.deadline=0; b.running=false; } }
  function remaining(b){ if(!b.deadline) return 0; return Math.max(0, Math.ceil((b.deadline-Date.now())/1000)); }

  // ==== Render ====
  function renderSteps(){ const b=currentBatch(); const c=byId('stepsContainer'); c.innerHTML=''; for(let idx=b.idx; idx<steps.length; idx++){ const stepId=idx+1; const div=document.createElement('div'); div.className='step'+(idx===b.idx?' active':''); const dur=steps[idx].duration?('‚è± '+fmt(steps[idx].duration)) : ''; div.innerHTML='<div style="opacity:.8;font-weight:800;">'+stepId+'. '+stepTitle(stepId)+'</div><div class="muted">'+stepHint(stepId)+'</div>'+(dur?'<div class="muted">'+dur+'</div>':''); c.appendChild(div);} }
  function updateInactiveBar(){ const bar=byId('inactiveBar'); if(!state.dualMode){ bar.style.display='none'; return; } const ob=otherBatch(); const started = (ob.idx>0) || (ob.deadline>0) || ob.running || (state.active===2);
    if(state.active===1 && ob.id===2 && !started){ bar.style.display='none'; return; }
    bar.style.display='block'; bar.classList.toggle('batch1', ob.id===1); bar.classList.toggle('batch2', ob.id===2);
    byId('inactiveLbl').textContent='Batch '+ob.id; byId('inactiveStep').textContent='Steg '+(ob.idx+1)+': '+stepTitle(ob.idx+1); byId('inactiveTimer').textContent= steps[ob.idx].duration>0 ? fmt(remaining(ob)) : '‚Äî';
    on('inactiveJump','click', ()=>{ state.active=ob.id; refreshHero(); });
  }
  function refreshHero(){ const b=currentBatch(); const stepId=b.idx+1; const hero=byId('hero'); if(state.active===1){ hero.classList.add('batch1'); hero.classList.remove('batch2'); } else { hero.classList.add('batch2'); hero.classList.remove('batch1'); }
    byId('heroBatchLabel').textContent='Batch '+state.active; byId('stepBadge').textContent=(b.idx+1)+' / '+steps.length; byId('heroStepNum').textContent='Steg '+stepId; byId('heroStepName').textContent=stepTitle(stepId); byId('heroHint').innerHTML=stepHint(stepId);
    const overall=Math.min(100,Math.max(0,(b.idx)/(steps.length-1)*100)); byId('heroProgOverall').style.width=overall+'%'; byId('heroProgPct').textContent=Math.round(overall)+'%'; byId('heroProgLabel').textContent='Steg '+stepId+' av '+steps.length;
    const showTimer=steps[b.idx].duration>0; byId('heroTimerWrap').style.display=showTimer?'grid':'none'; byId('timerDisplay').textContent=fmt(remaining(b));
    renderSteps(); updateInactiveBar();
  }

  // ==== Timer ====
  function tick(){ const b=currentBatch(); const st=steps[b.idx]; if(st.duration>0 && b.running && remaining(b)<=0){ b.running=false; if((b.idx+1)===5){ // temp efter steg 5
        stopAlarm(); openTempModal(5,state.active);
      } else {
        byId('ackBtn').style.display='inline-block'; startAlarm();
      }
    }
    byId('timerDisplay').textContent=fmt(remaining(b));
    // time progress
    if(st.duration>0 && b.deadline){ const rem=remaining(b); const elapsed=Math.max(0,st.duration-rem); const frac=Math.min(1,elapsed/st.duration); byId('heroProgTime').style.width=(frac*100)+'%'; } else { byId('heroProgTime').style.width='0%'; }
    updateInactiveBar();
    state.tickHandle=requestAnimationFrame(tick);
  }
  function startTimer(){ const b=currentBatch(); const st=steps[b.idx]; if(st.duration<=0) return; if(!b.deadline){ b.deadline=Date.now()+st.duration*1000; } b.running=true; byId('timerPause').textContent='Pausa'; }
  function stopTimer(){ const b=currentBatch(); b.running=false; byId('timerPause').textContent='Forts√§tt'; }
  function resetTimer(){ const b=currentBatch(); const st=steps[b.idx]; b.deadline=st.duration>0?(Date.now()+st.duration*1000):0; b.running=false; byId('timerPause').textContent='Forts√§tt'; }

  // ==== Temp modal (endast efter steg 5) ====
  function openTempModal(stepId,batch){ state.pendingTemp={stepId,batch}; byId('tempModalTitle').textContent='Ange degtemperatur ‚Äì Batch '+batch+' efter steg '+stepId; byId('tempInput').value=''; byId('tempModalBack').style.display='flex'; byId('tempInput').focus(); }
  function closeTempModal(){ byId('tempModalBack').style.display='none'; }
  function saveTemp(){ const v=parseFloat((byId('tempInput').value||'').replace(',','.')); if(isNaN(v)){ alert('Fyll i en giltig temperatur.'); return; } const was=state.pendingTemp?{...state.pendingTemp}:null; closeTempModal(); state.pendingTemp=null; if(was && was.stepId===5){ // efter steg 5, forts√§tt
      const b=currentBatch(); if(b.idx<steps.length-1){ setIdx(b,b.idx+1); refreshHero(); }
    } }

  // ==== Water calc ====
  function num(id){ const raw=(byId(id).value||'').replace(',','.'); const v=parseFloat(raw); return isFinite(v)?v:NaN; }
  function updateWaterCalc(){ const t=num('targetTemp'), f=num('flourTemp'), r=num('roomTemp'), fr=num('friction'); const target=isFinite(t)?t:22; const w=(isFinite(target)&&isFinite(f)&&isFinite(r)&&isFinite(fr))?((target*3)-(f+r+fr)):null; byId('waterCalc').textContent=(w==null?'‚Äî':(Math.round(w*10)/10)+' ¬∞C'); state.waterCalc=w; }

  // ==== Pre-weigh parts ====
  function partsText(mult, base){ const half=Math.round(base/2); if(Math.abs(mult-2)<1e-3) return {big:`2 √ó ${base} g`, total:2*base}; if(Math.abs(mult-1.5)<1e-3) return {big:`1 √ó ${base} g + 1 √ó ${half} g`, total:base+half}; return {big:`1 √ó ${base} g`, total:base}; }
  function refreshPreWeigh(){ const m=state.batchMult||1; const bw=partsText(m,state.base.water), bs=partsText(m,state.base.salt), bo=partsText(m,state.base.oil); byId('preWaterBig').textContent=bw.big; byId('preWaterSmall').textContent='= '+bw.total+' g'; byId('preSaltBig').textContent=bs.big; byId('preSaltSmall').textContent='= '+bs.total+' g'; byId('preOilBig').textContent=bo.big; byId('preOilSmall').textContent='= '+bo.total+' g'; }

  // ==== Navigation ====
  on('enterFs','click', ()=>{ if(fsSupported()){ try{ document.documentElement.requestFullscreen(); }catch(e){} } else { byId('fsHint').textContent='Din webbl√§sare saknar helsk√§rmsst√∂d.'; } });
  on('unlockAudioBtn','click', ()=>{ unlockAudioOnce(); const el=byId('beepFallback'); if(el){ try{ el.currentTime=0; el.play(); }catch(e){} } });
  on('testAlarmBtn','click', ()=>{ unlockAudioOnce(); startAlarm(); setTimeout(stopAlarm,2000); });

  on('toBatch','click', ()=> show('viewBatch'));
  on('backToOnboard','click', ()=> show('viewOnboard'));

  on('toTemps','click', ()=>{ const sel=document.querySelector('input[name="batch"]:checked'); state.batchMult=sel?parseFloat(sel.value):1; localStorage.setItem('deg_batch', state.batchMult); show('viewTemps'); updateWaterCalc(); });
  on('backToBatch','click', ()=> show('viewBatch'));

  on('saveTemps','click', ()=>{ updateWaterCalc(); });
  on('toPreWeigh','click', ()=>{ updateWaterCalc(); show('viewPre'); refreshPreWeigh(); });
  on('backToTemps','click', ()=> show('viewTemps'));

  on('toMixing','click', ()=>{ state.dualMode = (state.batchMult>=2); state.b2Started=false; setIdx(state.B1,0); setIdx(state.B2,0); state.active=1; show('viewMix'); refreshHero(); });
  on('prevStep','click', ()=>{ const b=currentBatch(); if(b.idx>0){ setIdx(b,b.idx-1); refreshHero(); } });
  on('nextStep','click', ()=>{ const b=currentBatch(); if(b.idx<steps.length-1){ setIdx(b,b.idx+1); if(state.dualMode && state.active===1 && (b.idx+1)===3){ // handoff
        state.active=2; state.b2Started=true; // hoppa till Batch 2 steg 1
        setIdx(state.B2,0); refreshHero(); return; }
      refreshHero(); }
  });
  on('timerPause','click', ()=>{ const st=steps[currentBatch().idx]; if(st.duration>0){ currentBatch().running?stopTimer():startTimer(); } });
  on('timerReset','click', ()=> resetTimer());
  on('ackBtn','click', ()=>{ stopAlarm(); byId('ackBtn').style.display='none'; const b=currentBatch(); if(b.idx<steps.length-1){ setIdx(b,b.idx+1); refreshHero(); } });

  on('inactiveJump','click', ()=>{ state.active = otherBatch().id; refreshHero(); });

  // Temp modal events
  on('tempSave','click', saveTemp);
  on('tempCancel','click', ()=>{ closeTempModal(); state.pendingTemp=null; });
  byId('tempModalBack').addEventListener('click', (e)=>{ if(e.target.id==='tempModalBack'){ closeTempModal(); state.pendingTemp=null; } });

  // Inputs
  ['targetTemp','flourTemp','roomTemp','friction'].forEach(id=>{ const el=byId(id); if(el){ el.addEventListener('input', updateWaterCalc); el.addEventListener('change', updateWaterCalc);} });
  const r=byId('volRange'); const lbl=byId('volLabel'); if(r&&lbl){ r.value=Math.round(state.volume*100); lbl.textContent=Math.round(state.volume*100)+'%'; r.addEventListener('input', ()=>{ state.volume=Math.max(0,Math.min(1,r.value/100)); if(state.gain){ state.gain.gain.value=state.volume; } localStorage.setItem('deg_alarm_vol', state.volume); lbl.textContent=Math.round(state.volume*100)+'%'; }); }

  // Clock
  setInterval(()=>{ const el=byId('clock'); if(el) el.textContent=new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }, 1000);

  // Start
  show('viewOnboard');
});
</script>
</body>
</html>
